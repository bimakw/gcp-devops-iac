# Copyright (c) 2024 Bima Kharisma Wicaksana
# Example: Sync database credentials from Secret Manager to Kubernetes
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
  namespace: default
spec:
  # How often to sync (default: 1h)
  refreshInterval: 1h

  # Reference to the SecretStore
  secretStoreRef:
    name: gcp-secret-manager
    kind: ClusterSecretStore

  # The Kubernetes Secret that will be created
  target:
    name: database-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Template allows you to transform the secret data
        DB_HOST: "{{ .db_host }}"
        DB_PORT: "{{ .db_port | default \"5432\" }}"
        DB_NAME: "{{ .db_name }}"
        DB_USER: "{{ .db_user }}"
        DB_PASSWORD: "{{ .db_password }}"
        # Create a connection string
        DATABASE_URL: "postgresql://{{ .db_user }}:{{ .db_password }}@{{ .db_host }}:{{ .db_port | default \"5432\" }}/{{ .db_name }}"

  # Map Secret Manager secrets to template variables
  data:
    - secretKey: db_host
      remoteRef:
        key: app-db-host  # Secret Manager secret name
    - secretKey: db_name
      remoteRef:
        key: app-db-name
    - secretKey: db_user
      remoteRef:
        key: app-db-user
    - secretKey: db_password
      remoteRef:
        key: app-db-password
---
# Alternative: Fetch entire JSON secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: app-config
  namespace: default
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: gcp-secret-manager
    kind: ClusterSecretStore
  target:
    name: app-config
    creationPolicy: Owner
  dataFrom:
    - extract:
        # Secret Manager secret containing JSON
        key: app-config-json
